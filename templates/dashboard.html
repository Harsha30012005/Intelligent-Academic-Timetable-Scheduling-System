<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - Intelligent Timetable System</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background:#f4f6f9; }

        .header-bar {
            background: linear-gradient(90deg,#1e3c72,#2a5298);
            color:white;
            padding:25px;
            border-radius:12px;
            margin-bottom:25px;
            text-align:center;
        }

        .card-custom {
            border-radius:12px;
            box-shadow:0 4px 14px rgba(0,0,0,0.08);
        }

        .room-block {
            background:#e9ecef;
            padding:6px;
            margin-bottom:5px;
            border-radius:8px;
            font-size:13px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Timetable AI</a>
        <div>
            <a class="btn btn-outline-light me-2" href="/dashboard">Dashboard</a>
            <a class="btn btn-outline-light me-2" href="/analytics">Analytics</a>
            <a class="btn btn-outline-light me-2" href="/coverage">Coverage</a>
            <a class="btn btn-outline-warning" href="/">Home</a>
        </div>
    </div>
</nav>

<div class="container mt-4">

<div class="header-bar">
    <h2>Scheduling Dashboard</h2>
</div>

<!-- ========================= -->
<!-- UPLOAD FORM -->
<!-- ========================= -->

<div class="card card-custom p-4 mb-4">

<form method="POST" action="/generate" enctype="multipart/form-data">

<div class="row mb-3">
<div class="col-md-4">
<label>Courses CSV</label>
<input type="file" name="courses" class="form-control" required>
</div>

<div class="col-md-4">
<label>Rooms CSV</label>
<input type="file" name="rooms" class="form-control" required>
</div>

<div class="col-md-4">
<label>Teacher Unavailability CSV</label>
<input type="file" name="unavailability" class="form-control" required>
</div>
</div>

<hr>

<h5>Optimization Weights</h5>

<label>Day Distribution Weight</label>
<input type="number" name="day_balance" value="2" class="form-control mb-2">

<label>Teacher Balance Weight</label>
<input type="number" name="teacher_balance" value="2" class="form-control mb-2">

<label>Room Utilization Balance Weight</label>
<input type="number" name="room_balance" value="2" class="form-control mb-3">

<div class="text-center">
<button class="btn btn-primary btn-lg">Generate Timetable</button>
</div>

</form>

</div>



<!-- ========================= -->
<!-- RESULTS SECTION -->
<!-- ========================= -->

{% if timetable %}

{% if warnings and warnings|length > 0 %}
<div class="alert alert-danger">
    <h5>âš  Scheduling Warnings</h5>
    <ul>
        {% for w in warnings %}
        <li>{{ w }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="card card-custom p-4 mb-4">

<h4 class="mb-3">Generated Timetable</h4>

<table class="table table-bordered text-center">
<thead class="table-dark">
<tr>
<th>Day</th>
{% for s in range(1, slots_per_day + 1) %}
<th>Slot {{ s }}</th>
{% endfor %}
</tr>
</thead>

<tbody>

{% for day, slots in timetable.items() %}
<tr>
<td><b>{{ day }}</b></td>

{% for slot in range(1, slots_per_day + 1) %}
<td>
{% for room, course in slots[slot].items() %}
{% if course %}
<div class="room-block">
<b>{{ room }}</b><br>
{{ course.code }}<br>
<small>{{ course.teacher }}</small><br>
<small><b>{{ course.batch }}</b></small>
</div>
{% endif %}
{% endfor %}
</td>
{% endfor %}

</tr>
{% endfor %}

</tbody>
</table>

</div>

<div class="row text-center mb-4">

<div class="col-md-4">
<div class="card bg-primary text-white p-3">
Total Sessions
<h4>{{ metrics.total_sessions }}</h4>
</div>
</div>

<div class="col-md-4">
<div class="card bg-success text-white p-3">
Execution Time
<h4>{{ metrics.execution_time }} sec</h4>
</div>
</div>

<div class="col-md-4">
<div class="card bg-dark text-white p-3">
Rooms Used
<h4>{{ room_summary|length }}</h4>
</div>
</div>

<hr>
<h4 class="mt-4 mb-4 text-center">AI Evaluation Metrics</h4>

<div class="row text-center">

<div class="col-md-3">
<canvas id="utilChart"></canvas>
<p><b>Room Utilization</b></p>
</div>

<div class="col-md-3">
<canvas id="teacherFairChart"></canvas>
<p><b>Teacher Fairness</b></p>
</div>

<div class="col-md-3">
<canvas id="dayBalanceChart"></canvas>
<p><b>Day Balance</b></p>
</div>

<div class="col-md-3">
<canvas id="efficiencyChart"></canvas>
<p><b>Global Efficiency</b></p>
</div>

</div>

</div>

<div class="text-center mb-4">
<a href="/download_excel" class="btn btn-success btn-lg me-3">Download Excel</a>
<a href="/download_pdf" class="btn btn-danger btn-lg">Download PDF</a>
</div>
{% endif %}

</div>

<!-- AI Doughnut Charts Script -->
{% if timetable %}
<script>

function createDoughnut(id, value, color) {
    new Chart(document.getElementById(id), {
        type: 'doughnut',
        data: {
            labels: ['Score', 'Remaining'],
            datasets: [{
                data: [value, 100 - value],
                backgroundColor: [color, '#e9ecef'],
                borderWidth: 1
            }]
        },
        options: {
            cutout: '70%',
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            }
        },
        plugins: [{
            id: 'centerText',
            beforeDraw: function(chart) {
                const width = chart.width;
                const height = chart.height;
                const ctx = chart.ctx;
                ctx.restore();

                const fontSize = (height / 5).toFixed(2);
                ctx.font = fontSize + "px Arial";
                ctx.textBaseline = "middle";
                ctx.fillStyle = "#000";

                const text = value + "%";
                const textX = Math.round((width - ctx.measureText(text).width) / 2);
                const textY = height / 2;

                ctx.fillText(text, textX, textY);
                ctx.save();
            }
        }]
    });
}

createDoughnut('utilChart', {{ metrics.room_utilization }}, '#28a745');
createDoughnut('teacherFairChart', {{ metrics.teacher_fairness }}, '#007bff');
createDoughnut('dayBalanceChart', {{ metrics.day_balance }}, '#6f42c1');
createDoughnut('efficiencyChart', {{ metrics.efficiency_score }}, '#ffc107');

</script>
{% endif %}


</body>
</html>
